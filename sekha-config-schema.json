{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://sekha.ai/schemas/config-v2.json",
  "title": "Sekha v2.0 Configuration Schema",
  "description": "JSON schema for validating Sekha v2.0 configuration files",
  "type": "object",
  "required": ["llm_providers", "default_models"],
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^2\\.0$",
      "description": "Configuration version (must be 2.0)"
    },
    "llm_providers": {
      "type": "array",
      "description": "List of LLM providers",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/provider"
      }
    },
    "default_models": {
      "$ref": "#/definitions/defaultModels"
    },
    "routing": {
      "$ref": "#/definitions/routing"
    },
    "server_host": {
      "type": "string",
      "default": "0.0.0.0"
    },
    "server_port": {
      "type": "integer",
      "minimum": 1024,
      "maximum": 65535,
      "default": 8080
    },
    "database_url": {
      "type": "string",
      "format": "uri"
    },
    "chroma_url": {
      "type": "string",
      "format": "uri"
    },
    "llm_bridge_url": {
      "type": "string",
      "format": "uri"
    },
    "mcp_api_key": {
      "type": "string",
      "minLength": 32,
      "description": "API key for MCP access (minimum 32 characters)"
    },
    "rest_api_key": {
      "type": "string",
      "minLength": 32,
      "description": "Optional separate API key for REST API"
    },
    "additional_api_keys": {
      "type": "array",
      "items": {
        "type": "string",
        "minLength": 32
      },
      "description": "Additional valid API keys"
    },
    "max_connections": {
      "type": "integer",
      "minimum": 1,
      "maximum": 100,
      "default": 10
    },
    "log_level": {
      "type": "string",
      "enum": ["debug", "info", "warn", "error"],
      "default": "info"
    },
    "summarization_enabled": {
      "type": "boolean",
      "default": true
    },
    "pruning_enabled": {
      "type": "boolean",
      "default": true
    },
    "rate_limit_per_minute": {
      "type": "integer",
      "minimum": 1,
      "default": 1000
    },
    "cors_enabled": {
      "type": "boolean",
      "default": true
    }
  },
  "definitions": {
    "provider": {
      "type": "object",
      "required": ["id", "type", "base_url", "priority"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z0-9_-]+$",
          "description": "Unique provider identifier (lowercase, alphanumeric, hyphens, underscores)"
        },
        "type": {
          "type": "string",
          "enum": ["ollama", "litellm", "openrouter", "openai", "anthropic"],
          "description": "Provider type"
        },
        "base_url": {
          "type": "string",
          "format": "uri",
          "description": "Base URL for provider API"
        },
        "api_key": {
          "type": "string",
          "description": "Optional API key (can use ${ENV_VAR} syntax)"
        },
        "timeout": {
          "type": "integer",
          "minimum": 1,
          "maximum": 600,
          "default": 120,
          "description": "Request timeout in seconds"
        },
        "priority": {
          "type": "integer",
          "minimum": 1,
          "maximum": 100,
          "description": "Provider priority (1 = highest, try first)"
        },
        "models": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/model"
          },
          "description": "List of models available from this provider"
        }
      }
    },
    "model": {
      "type": "object",
      "required": ["model_id", "task", "context_window"],
      "properties": {
        "model_id": {
          "type": "string",
          "description": "Model identifier (e.g., 'llama3.1:8b', 'gpt-4o')"
        },
        "task": {
          "type": "string",
          "enum": ["embedding", "chat_small", "chat_large", "chat_smart", "vision", "audio"],
          "description": "Primary task this model is suited for"
        },
        "context_window": {
          "type": "integer",
          "minimum": 128,
          "maximum": 2000000,
          "description": "Maximum context window size in tokens"
        },
        "dimension": {
          "type": "integer",
          "minimum": 128,
          "maximum": 4096,
          "description": "Embedding dimension (required for embedding models)"
        },
        "supports_vision": {
          "type": "boolean",
          "default": false,
          "description": "Whether model supports image inputs"
        },
        "supports_audio": {
          "type": "boolean",
          "default": false,
          "description": "Whether model supports audio inputs"
        }
      },
      "if": {
        "properties": {
          "task": {
            "const": "embedding"
          }
        }
      },
      "then": {
        "required": ["dimension"]
      }
    },
    "defaultModels": {
      "type": "object",
      "required": ["embedding", "chat_fast", "chat_smart"],
      "properties": {
        "embedding": {
          "type": "string",
          "description": "Default model for embedding generation"
        },
        "chat_fast": {
          "type": "string",
          "description": "Default model for simple/fast chat completions"
        },
        "chat_smart": {
          "type": "string",
          "description": "Default model for complex reasoning tasks"
        },
        "chat_vision": {
          "type": ["string", "null"],
          "description": "Default model for vision tasks (optional)"
        }
      }
    },
    "routing": {
      "type": "object",
      "properties": {
        "auto_fallback": {
          "type": "boolean",
          "default": true,
          "description": "Automatically fallback to next provider on failure"
        },
        "require_vision_for_images": {
          "type": "boolean",
          "default": true,
          "description": "Require vision-capable model when images are present"
        },
        "max_cost_per_request": {
          "type": ["number", "null"],
          "minimum": 0,
          "description": "Maximum cost per request in USD (optional)"
        },
        "circuit_breaker": {
          "$ref": "#/definitions/circuitBreaker"
        }
      }
    },
    "circuitBreaker": {
      "type": "object",
      "properties": {
        "failure_threshold": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "default": 3,
          "description": "Number of consecutive failures before opening circuit"
        },
        "timeout_secs": {
          "type": "integer",
          "minimum": 1,
          "maximum": 600,
          "default": 60,
          "description": "Seconds to wait before attempting recovery"
        },
        "success_threshold": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "default": 2,
          "description": "Successes needed in half-open state to close circuit"
        }
      }
    }
  }
}

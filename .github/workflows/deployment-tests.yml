name: Deployment Tests


on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]


jobs:
  helm-tests:
    name: Test Helm Charts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      
      - name: Install kubeconform
        run: |
          go install github.com/yannh/kubeconform/cmd/kubeconform@latest
      
      - name: Run Helm tests
        run: ./helm/tests/test_helm.sh


  terraform-tests:
    name: Test Terraform Configs
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      
      - name: Run Terraform validation
        run: ./cloud/tests/test_terraform.sh


  docker-url-tests:
    name: Test Docker Deployment URLs
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test docker-compose.prod.yml exists
        run: |
          if [ -f "docker/docker-compose.prod.yml" ]; then
            echo "✅ docker-compose.prod.yml found"
          else
            echo "❌ docker-compose.prod.yml not found"
            exit 1
          fi

      - name: Validate docker-compose syntax
        run: |
          docker-compose -f docker/docker-compose.prod.yml config > /dev/null
          echo "✅ docker-compose.prod.yml is valid"

      - name: Test deploy-docker.sh script syntax
        run: |
          chmod +x docker/deploy-docker.sh
          bash -n docker/deploy-docker.sh
          echo "✅ deploy-docker.sh has valid syntax"


  deployment-script-tests:
    name: Test Deployment Scripts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test deploy-k8s.sh syntax
        run: |
          chmod +x deploy-k8s.sh
          bash -n deploy-k8s.sh
          ./deploy-k8s.sh --help
          echo "✅ deploy-k8s.sh validated"

      - name: Test deploy-cloud.sh syntax
        run: |
          chmod +x docker/deploy-cloud.sh
          bash -n docker/deploy-cloud.sh
          echo "✅ deploy-cloud.sh validated"

      - name: Test cloud provider scripts
        run: |
          chmod +x cloud/azure/deploy.sh cloud/gcp/deploy.sh
          bash -n cloud/azure/deploy.sh
          bash -n cloud/gcp/deploy.sh
          echo "✅ Cloud provider scripts validated"

  docker-compose-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Run Docker Compose tests
        run: cd tests && cargo test --test test_docker_compose        

  status-check:
    name: All Tests Passed
    runs-on: ubuntu-latest
    needs: [helm-tests, terraform-tests, docker-url-tests, deployment-script-tests]
    if: always()
    
    steps:
      - name: Check status
        run: |
          if [ "${{ needs.helm-tests.result }}" != "success" ]; then
            echo "❌ Helm tests failed"
            exit 1
          fi
          if [ "${{ needs.terraform-tests.result }}" != "success" ]; then
            echo "❌ Terraform tests failed"
            exit 1
          fi
          if [ "${{ needs.docker-url-tests.result }}" != "success" ]; then
            echo "❌ Docker URL tests failed"
            exit 1
          fi
          if [ "${{ needs.deployment-script-tests.result }}" != "success" ]; then
            echo "❌ Deployment script tests failed"
            exit 1
          fi
          echo "✅ All deployment tests passed!"
